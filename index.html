<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" type="text/css" href="//stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="//stackpath.bootstrapcdn.com/bootswatch/4.1.3/materia/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="//unpkg.com/formiojs@latest/dist/formio.full.min.css">
  <script type="text/javascript" src="//unpkg.com/formiojs@latest/dist/formio.full.min.js"></script>
  <script type="text/javascript" src="http://activiti-keycloak.jx-staging.54.159.228.81.nip.io/auth/js/keycloak.js"></script>

  <style id="compiled-css" type="text/css">
      h1 {
        padding: 40px 0 0 40px
      }
      #formio {
        padding: 20px 40px 40px 40px
      }
  </style>

  <script type="text/javascript">
  var tasksQuery = "query { Tasks(where: {status: {NE: COMPLETED}}) { select { id name assignee priority dueDate status processInstance { businessKey } variables { name value } }}}"  ;
  var serverUrl = 'http://activiti-cloud-notifications.jx-staging.54.159.228.81.nip.io';

  var keycloak = Keycloak('keycloak.json');
    
  keycloak.init({ onLoad: 'check-sso' })
          .success(function(authenticated) {
              alert(authenticated ? 'authenticated' : 'not authenticated');
          }).error(function() {
              alert('failed to initialize');
          });  
    
  var loadForm = function() {
      var baseUrl = "http://formio.jx-staging.54.159.228.81.nip.io";
      var formPath = "formio-upload";

      fetch('http://activiti-cloud-notifications.jx-staging.54.159.228.81.nip.io/graphql', {
          method: 'post',
          headers: {
            'Content-Type': 'application/json',
            'Auhtorization': 'Bearer ' + keycloak.token
          },
          mode: 'cors',
          body: JSON.stringify({
            "query": tasksQuery,
            "variables": null
          })
      }).then(function(response) {
        return response.json();
      }).then(function(json) {
        console.log(json)
      })
    
      fetch(baseUrl+'/user/login', {
          method: 'post',
          headers: {
            'Content-Type': 'application/json'
          },
          mode: 'cors',
          body: JSON.stringify({
            "data": {
              "email": "admin@example.com",
              "password": "password"
            }
          })
        }).then(function(response) {
          Formio.setBaseUrl(baseUrl);
          Formio.setProjectUrl(baseUrl);
          Formio.setToken(response.headers.get('x-jwt-token'));

          Formio.createForm(document.getElementById('formio'), baseUrl+'/'+formPath).then(function(form) {
              form.submission = {
                data: {
                   requestId: 'requestId-'+new Date().getTime(),
                   directiveDate: new Date(),
                   requestor: 'John Dow',
                   amount: 50000,
                   email: 'john@doe.com',
                   subject: 'Trade Request',
                   accountNumber: 12345678
                }
              };

              // What to do when the submit begins.
              form.on('submitDone', function(submission) {
                var submissionId=submission._id;

                // Load submission
                Formio.createForm(document.getElementById('formio'), baseUrl + '/' + formPath + '/submission/' + submissionId, {
                  readOnly: true,
                  viewAsHtml: true
                });
             });
        })
      })
    }
</script>

</head>
<body>
  <h1>IRT Request</h1>
  <div id="formio"></div>
</body>
</html>
