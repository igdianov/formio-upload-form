
<!DOCTYPE html>
<html>
<head>
  <base href="http://formio-file-upload.introproventures.com">
  <style>html { font-size: 14px; font-family: Arial, Helvetica, sans-serif; }</style>
  <title></title>
  <link rel="stylesheet" href="//kendo.cdn.telerik.com/2018.3.1017/styles/kendo.common-material.min.css" />
  <link rel="stylesheet" href="//kendo.cdn.telerik.com/2018.3.1017/styles/kendo.material.min.css" />
  <link rel="stylesheet" href="//kendo.cdn.telerik.com/2018.3.1017/styles/kendo.material.mobile.min.css" />

  <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootswatch/4.1.3/materia/bootstrap.min.css" />
  <link rel="stylesheet" href="//unpkg.com/formiojs@latest/dist/formio.full.min.css" />

  <script src="//unpkg.com/formiojs@latest/dist/formio.full.min.js"></script>

  <script src="//kendo.cdn.telerik.com/2018.3.1017/js/jquery.min.js"></script>
  <script src="//kendo.cdn.telerik.com/2018.3.1017/js/kendo.all.min.js"></script>

  <script type="text/javascript" src="http://activiti-keycloak.jx-staging.54.159.228.81.nip.io/auth/js/keycloak.js"></script>   
</head>
<body>
  <div id="example">
    <div id="grid"></div>
    <div id="formio"></div>
    
    <script>
      var baseUrl = "http://formio.jx-staging.54.159.228.81.nip.io";
      var serverUrl = 'http://activiti-cloud-notifications.jx-staging.54.159.228.81.nip.io';      
      var READ_PRODUCTS_QUERY = "query {" +
          " Tasks(where: {status: {NE: COMPLETED}}) { select { id name assignee priority dueDate status formKey processInstance { businessKey } variables { name value } } }" +
          "}";

      var keycloak = Keycloak(serverUrl+'/keycloak.json');

      var loadTaskGrid = function() {
          var dataSource = new kendo.data.DataSource({
              transport: {
                  read: {
                      contentType: "application/json",
                      url: serverUrl+"/graphql",
                      type: "POST",
                      data: function() {
                          console.log('data');
                          return { query: READ_PRODUCTS_QUERY };
                      },
                      beforeSend: function(req) {
                          console.log('beforeSend');
                          req.setRequestHeader('Authorization', 'Bearer '+keycloak.token);
                      }
                  },
                  parameterMap: function(options, operation) {
                      console.log('parameterMap');

                      return  kendo.stringify({
                          query: options.query,
                          variables: options.variables
                      });
                  }
              },
              schema: {
                  data: function(response) {
                      console.log('response');
                      return response.data.Tasks.select; 
                  },
                  total: function(response) {
                      console.log('total');
                      return response.data.Tasks.select.length;
                  },
                  model: {
                      id: "id",
                      fields: {
                          id: { type: "string", editable: false },
                          name: { type: "string", editable: false },
                          assignee: { type: "string" },
                          status: { type: "string" }
                      }
                  }
              },
              pageSize: 20
          });

          $("#grid").kendoGrid({
              dataSource: dataSource,
              height: 750,
              groupable: true,
              sortable: true,
              pageable: false,
              editable: "inline",
              columns: [{
                  field: "id",
                  title: "Task ID"
              },
              {
                  field: "name",
                  title: "Task Name"
              },
              {
                  field: "assignee",
                  title: "Assignee"
              },
              {
                  field: "status",
                  title: "Status"
              },
              { command: [{ text: "View Task", click: viewTask }, { text: "Documents", click: viewDocuments }], 
                title: " ", width: "280px" 
              }]
          });

          function viewDocuments(e) {
            e.preventDefault();
            var tab = window.open("http://localhost:5000/#/irt", '_blank');
            tab.focus();
          }
        
          function viewTask(e) {
              e.preventDefault();
              var formioEl = $("#formio");
            
              var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
              console.log('Task json',JSON.stringify(dataItem, null, 2));
            
              var formKey = dataItem.formKey || "irt-due-dilligence-task";
              var formId = dataItem.variables.find(v => v.name == 'formId').value; // "5c3d0b3a51bc770018dc473b";
              var submissionId = dataItem.variables.find(v => v.name == 'submissionId').value; "5c3e079051bc770018dc4761";
              var taskId = dataItem.id; //'08a99374-18e1-11e9-ab3c-d26afa2117c5';        
              
              var taskWindow = formioEl.kendoWindow({
                    width: "600px",
                    height: "600px",
                    title: dataItem.name,
                    visible: false,
                    actions: [
                        "Pin",
                        "Minimize",
                        "Maximize",
                        "Close"
                    ],
                    //close: onClose
                }).data("kendoWindow");
            
              formioLogin(baseUrl,"admin@example.com","password")
                .then(function(profile) {
                  return fetchForm(formId);
                }).then(function(form) {
                  return fetchSubmission(form.path, submissionId);
                }).then(function(submission) {
                  Formio.createForm(document.getElementById('formio'), baseUrl+'/'+formKey).then(function(form) {
                    submission.data['taskId'] = taskId;

                    form.submission = {
                      data: submission.data
                    };
                    
                    taskWindow.center()
                            .open();  

                    // What to do when the submit begins.
                    form.on('submitDone', function(submission) {
                      var submissionId=submission._id;

                      // Load submission
                      Formio.createForm(document.getElementById('formio'), baseUrl + '/' + formKey + '/submission/' + submissionId, {
                        readOnly: true,
                        viewAsHtml: true
                      });
                   });
                })
              })
              //wnd.content(detailsTemplate(dataItem));
              //wnd.center().open();
          }              
      };
      
      var fetchForm = function(formId) {	
        return fetch(baseUrl+'/form/'+formId, {
          method: 'get',
          headers: {
            'Content-Type': 'application/json',
            'x-jwt-token': Formio.getToken()
          },
          mode: 'cors',
        }).then(function(response) {
          return response.json();
        });
      };

      var fetchSubmission = function(formPath, submissionId) {
        return fetch(baseUrl + '/' + formPath +'/submission/' + submissionId, {
          method: 'get',
          headers: {
            'Content-Type': 'application/json',
            'x-jwt-token': Formio.getToken()
          },
          mode: 'cors',
        }).then(function(response) {
          return response.json();
        });;
      };

      var formioLogin = function(baseUrl, email, password) {
        return fetch(baseUrl+'/user/login', {
            method: 'post',
            headers: {
              'Content-Type': 'application/json'
            },
            mode: 'cors',
            body: JSON.stringify({
              "data": {
                  "email": email,
                  "password": password
              }
            })
          }).then(function(response) {
            Formio.setBaseUrl(baseUrl);
            Formio.setProjectUrl(baseUrl);
            Formio.setToken(response.headers.get('x-jwt-token'));

            return response.json();
          })
      };      
        
      keycloak.init({ onLoad: 'login-required' })
            .success(function(authenticated) {
                console.log('Keycloak: ', authenticated ? 'authenticated' : 'not authenticated');
                loadTaskGrid();
          
            }).error(function() {
                alert('failed to initialize');
            });          
    </script>
  </div>
</body>
</html>
